<?xml version="1.0" encoding="UTF-8"?>
<project name="ditaSourceUpdate" default="updateSource" basedir=".">
	<property file="build.properties" />
	<property name="map.dtd.loc" value="${dita.dir}/dtd/technicalContent/dtd/map.dtd" />
	<property name="source.dtd.loc" value="${dita.dir}/dtd/technicalContent/dtd/topic.dtd" />
	<taskdef resource="net/sf/antcontrib/antcontrib.properties" />
	<target name="updateSourceDoctype">
		<replaceregexp>
			<fileset dir="${source.dir}">
				<include name="**/*" />
			</fileset>
			<regexp pattern="encoding=&quot;utf-8&quot;" />
			<substitution expression="encoding=&quot;UTF-8&quot;" />
		</replaceregexp>
		<!--<replaceregexp>
			<fileset dir="${source.dir}">
				<include name="**/*.ditamap" />
			</fileset>
			<regexp pattern="PUBLIC &quot;-//OASIS//DTD DITA(.*)" />
			<substitution expression="" />
		</replaceregexp>-->
		<!--<replaceregexp>
			<fileset dir="${source.dir}">
				<include name="**/*" />
			</fileset>
			<regexp pattern="&quot;../../dtd/ditabase.dtd&quot;&gt;" />
			<substitution expression="" />
		</replaceregexp>-->
		<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.ditamap" />
			</fileset>
			<regexp pattern="&lt;\!DOCTYPE(.*)$(.*)" />
			<substitution expression="&lt;\!DOCTYPE map PUBLIC &quot;-//OASIS//DTD DITA Map//EN&quot; &quot;../../DITA-OT1.5.1/dtd/technicalContent/dtd/map.dtd&quot;&gt;" />
		</replaceregexp>
		<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="&lt;\!DOCTYPE topic(.*)$(.*)" />
			<substitution expression="&lt;\!DOCTYPE topic PUBLIC &quot;-//OASIS//DTD DITA 1.2 Topic//EN&quot; &quot;../../DITA-OT1.5.1/dtd/technicalContent/dtd/topic.dtd&quot;&gt;" />
		</replaceregexp>
		<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="&lt;\!DOCTYPE reference(.*)$(.*)" />
			<substitution expression="&lt;\!DOCTYPE reference PUBLIC &quot;-//OASIS//DTD DITA 1.2 Reference//EN&quot; &quot;../../DITA-OT1.5.1/dtd/technicalContent/dtd/reference.dtd&quot;&gt;" />
		</replaceregexp>
		<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="&lt;\!DOCTYPE concept(.*)$(.*)" />
			<substitution expression="&lt;\!DOCTYPE concept PUBLIC &quot;-//OASIS//DTD DITA 1.2 Concept//EN&quot; &quot;../../DITA-OT1.5.1/dtd/technicalContent/dtd/concept.dtd&quot;&gt;" />
		</replaceregexp>
		<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="&lt;\!DOCTYPE glossary(.*)$(.*)" />
			<substitution expression="&lt;\!DOCTYPE glossary PUBLIC &quot;-//OASIS//DTD DITA 1.2 Glossary//EN&quot; &quot;../../DITA-OT1.5.1/dtd/technicalContent/dtd/glossary.dtd&quot;&gt;" />
		</replaceregexp>
		<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="&lt;\!DOCTYPE task(.*)$(.*)" />
			<substitution expression="&lt;\!DOCTYPE task PUBLIC &quot;-//OASIS//DTD DITA 1.2 Task//EN&quot; &quot;../../DITA-OT1.5.1/dtd/technicalContent/dtd/task.dtd&quot;&gt;" />
		</replaceregexp>
		<replaceregexp flags="g">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="xmlns\:ditaarch=&quot;http\://dita.oasis-open.org/architecture/2005/&quot;" />
			<substitution expression="" />
		</replaceregexp>
		<replaceregexp flags="g">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="fm_format=&quot;(.*)&quot;" />
			<substitution expression="" />
		</replaceregexp>
		<replaceregexp flags="g">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="fm_angle=&quot;(.*)&quot;" />
			<substitution expression="" />
		</replaceregexp>
	</target>

	<target name="updateSource">
		<antcall target="updateSourceDoctype" />
		<foreach target="updateMap" param="dita.map">
			<fileset dir="${source.dir}">
				<include name="**/*.ditamap" />
			</fileset>
		</foreach>
		<foreach target="updateDitaSource" param="dita.source">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
		</foreach>
		<!--<antcall target="updateSourceDoctype" />
		-->
		<!--<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
				<include name="**/*.ditamap" />
			</fileset>
			<regexp pattern="(&lt;!DOCTYPE[ ]+(map|concept|task|topic|reference|glossary))(.*?)(PUBLIC[ ]+&quot;-//OASIS//DTD[ ]+DITA[ ]*[1234567890\.]*[ ]*(Map|Concept|Task|Topic|Reference|Glossary)//EN&quot;[ ]+&quot;(../)*DITA-OT1.5.1/dtd/technicalContent/dtd/(map|concept|task|topic|reference|glossary).dtd&quot;&gt;)" />
			<substitution expression="" />
		</replaceregexp>-->
		<antcall target="updateSourceDoctype" />
		<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.xml" />
			</fileset>
			<regexp pattern="^[ ]*PUBLIC &quot;-//OASIS//DTD DITA 1.2 Topic//EN&quot;(.*)" />
			<substitution expression="" />
		</replaceregexp>
		<replaceregexp flags="m">
			<fileset dir="${source.dir}">
				<include name="**/*.ditamap" />
			</fileset>
			<regexp pattern="^[ ]*PUBLIC &quot;-//OASIS//DTD DITA Map//EN&quot;(.*)" />
			<substitution expression="" />
		</replaceregexp>
		<replaceregexp flags="g">
			<fileset dir="${source.dir}">
				<include name="**/*.tmp" />
			</fileset>
			<regexp pattern="xmlns\:ditaarch=&quot;http\://dita.oasis-open.org/architecture/2005/&quot;" />
			<substitution expression="" />
		</replaceregexp>
	</target>
	<target name="updateMap">
		<echo>${dita.map}</echo>
		<xslt basedir="${source.dir}" in="${dita.map}" out="${dita.map}.tmp" extension="tmp" style="ditaMapUpdate.xsl">
			<classpath location="${dita.dir}/lib/saxon/saxon9.jar" />
			<xmlcatalog>
				<dtd publicid="-//OASIS//DTD DITA Map//EN" location="${map.dtd.loc}" />
			</xmlcatalog>
		</xslt>
		<move file="${dita.map}.tmp" tofile="${dita.map}">
		</move>
	</target>
	<target name="updateDitaSource">
		<echo>${dita.source}</echo>
		<xslt basedir="${source.dir}" in="${dita.source}" out="${dita.source}.tmp" extension="tmp" style="ditaSourceUpdate.xsl">
			<classpath location="${dita.dir}/lib/saxon/saxon9.jar" />
			<xmlcatalog>
				<dtd publicid="-//OASIS//DTD DITA 1.2 Topic//EN" location="${source.dtd.loc}" />
			</xmlcatalog>
		</xslt>
		<move file="${dita.source}.tmp" tofile="${dita.source}" />
	</target>
</project>